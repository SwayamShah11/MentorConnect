{% extends 'menti/base.html' %}
{% load static %}
{% block title %} Schedule Meeting {% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-8">

      <!-- Mentor Details Card -->
      <div class="card mb-4 bg-black p-0">
        <div class="card-header bg-dark text-light">
          <h4>Schedule Meeting with {% if mentor.name %} {{ mentor.name }} {% else %} {{ mentor.user.username }} {% endif %}</h4>
        </div>
        <div class="card-body d-flex bg-light text-black">
          {% if mentor.image %}
            <img src="{{ mentor.image.url }}"
                 class="rounded-circle shadow-sm border border-3 border-light"
                 style="width:80px; height:80px; object-fit: cover;">
            {% else %}
            <img src="/media/default.png"
                 class="rounded-circle shadow-sm border border-3 border-light"
                 style="width:80px; height:80px; object-fit: cover;">
            {% endif %}
          <div>
            <p><strong>Name:</strong> {% if mentor.name %} {{ mentor.name }} {% else %} {{ mentor.user.username }} {% endif %}</p>
            <p><strong>Email:</strong> {{ mentor.user.email }}</p>
            <p><strong>Specialization:</strong> {% if mentor.expertise %} {{ mentor.expertise }} {% else %} - {% endif %}</p>
            <p><strong>Availability:</strong> 09:00 AM - 10:00 AM </p>
          </div>
        </div>
      </div>

      <!-- Meeting Form -->
      <div class="card bg-black p-0">
  <div class="card-header bg-dark text-light">
    <h5>Schedule a Meeting</h5>
  </div>

  <div class="card-body bg-light text-black">
    <form method="POST">
      {% csrf_token %}

      <!-- ðŸ“… Calendar -->
      <div class="card bg-light p-3 mb-3">
        <h5>Select Date & Time</h5>
        <div id="calendar"></div>
      </div>

      <!-- Hidden inputs populated by calendar -->
      <input type="hidden" id="appointment_date" name="appointment_date">
      <input type="hidden" id="time_slot" name="time_slot">

      <!-- Optional: show selected slot -->
      <div class="alert alert-info mt-2" id="selected-slot" style="display:none;">
        Selected: <span id="selected-text"></span>
      </div>

      <button type="submit" class="btn btn-success mt-3">
        Schedule Meeting
      </button>
    </form>
  </div>
</div>
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mt-4 gap-3">
            <a href="{% url 'account' %}"
               class="btn btn-warning btn-lg rounded-pill px-4 shadow-sm mx-5">
                <i class="bi bi-arrow-left-circle"></i> Back
            </a>
        </div>
    </div>
  </div>
</div><br>
<style>
#calendar {
height: 400px;
}

/* Force calendar event text to stay on one line */
.fc-event-title,
.fc-event-time {
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function () {
  let calendarEl = document.getElementById('calendar');

  let calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    selectable: true,
    nowIndicator: true,
    allDaySlot: false,

    slotMinTime: "08:00:00",
    slotMaxTime: "17:00:00",

    slotLabelFormat: {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    },

    eventTimeFormat: {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    },

    eventSources: [
      {
        events: [
          {
            title: 'Lunch Break',
            startTime: '12:00',
            endTime: '13:00',
            daysOfWeek: [1,2,3,4,5],
            display: 'background',
            backgroundColor: '#f8d7da'
          }
        ]
      },
      {
        url: "{% url 'meetings_calendar_api' %}"
      }
    ],

    select: function(info) {
      let start = info.start;
      let hour = start.getHours();

      if (start < new Date()) {
        alert("Cannot schedule in the past");
        return;
      }

      if (hour >= 12 && hour < 13) {
        alert("Lunch break (12:00â€“13:00). Please select another time.");
        return;
      }

      document.getElementById("appointment_date").value =
        start.toISOString().slice(0,10);

      document.getElementById("time_slot").value =
        start.toTimeString().slice(0,5);

      // âœ… SHOW selected slot on UI
      const slotDiv = document.getElementById("selected-slot");
      const slotText = document.getElementById("selected-text");

      slotText.innerText = start.toISOString().slice(0,10) + " at " + start.toTimeString().slice(0,5);

      slotDiv.style.display = "block"; // ðŸ”¥ THIS FIXES VISIBILITY

      alert("Time selected. Submit to confirm.");
    },
    eventDidMount: function(info) {
     const mentor = info.event.extendedProps.mentor;
     info.el.title = `Meeting with ${mentor}`;
    },
    eventClick: function() {
      alert("This slot is already booked.");
    }
  });

  calendar.render();
});
</script>
{% endblock %}