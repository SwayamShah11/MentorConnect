{% extends "mentor/base1.html" %}
{% load static %}
{% block title %}Mentor–Mentee Interaction{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <div>
      <h3 class="fw-bold mb-0">Mentor–Mentee Interaction</h3>
      <small class="text-muted">Record meetings and attendance for your mentees.</small>
    </div>
    <button class="btn btn-warning fw-semibold mt-3 mt-md-0"
            data-bs-toggle="modal" data-bs-target="#interactionModal">
      <i class="bi bi-plus-circle me-1"></i> Add Interaction
    </button>
  </div>

    <!-- Export Buttons -->
<div class="mb-3 d-flex gap-2 flex-wrap">
  <a href="{% url 'export_interactions' 'excel' %}" class="btn btn-outline-success">
    <i class="bi bi-file-earmark-excel"></i> Export Excel
  </a>
  <a href="{% url 'export_interactions' 'pdf' %}" class="btn btn-outline-danger">
    <i class="bi bi-file-earmark-pdf"></i> Export PDF
  </a>
</div>

  <!-- Toast container (Bootstrap 5) -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
    {% for message in messages %}
      <div class="toast align-items-center text-bg-{{ message.tags|default:'info' }} border-0 show mb-2"
           role="alert">
        <div class="d-flex">
          <div class="toast-body">
            {{ message }}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    {% endfor %}
  </div>

    <!-- Filter Form -->
<form method="get" class="row g-2 mb-3">
  <div class="col-md-4">
    <label class="form-label fw-semibold">Date</label>
    <input type="date" name="date" class="form-control" value="{{ request.GET.date }}">
  </div>
  <div class="col-md-4">
    <label class="form-label fw-semibold">Semester</label>
    <select name="semester" class="form-select">
      <option value="">-- Select Semester --</option>
      {% for s in semesters %}
        <option value="{{ s }}" {% if request.GET.semester == s %}selected{% endif %}>
          {{ s }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label fw-semibold">Apply Filter</label>
    <button class="btn btn-primary w-100">
      <i class="bi bi-funnel"></i> Filter
    </button>
  </div>
</form>

  <!-- Interactions table -->
  <div class="card shadow-sm border-0">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th scope="col">Date</th>
              <th scope="col">Semester</th>
              <th scope="col">Agenda Discussed</th>
              <th scope="col">Mentees Present</th>
              <th scope="col" class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if interactions %}
              {% for i in interactions %}
                <tr>
                  <td>{{ i.date|date:"d-m-Y" }}</td>
                  <td>{{ i.semester }}</td>
                  <td style="max-width: 350px;">
                    <div class="small text-wrap">{{ i.agenda }}</div>
                  </td>
                  <td style="max-width: 260px;">
                    <ul class="list-unstyled mb-0 small">
                      {% for u in i.mentees.all %}
                        <li>
                          {{ u.profile.student_name }} ({{ u.profile.moodle_id }})
                        </li>
                      {% endfor %}
                    </ul>
                  </td>
                  <td class="text-center">
                    <!-- ✅ EDIT (opens same modal) -->
                      <button type="button"
                              class="btn btn-outline-primary btn-sm edit-btn"
                              data-id="{{ i.id }}"
                              data-date="{{ i.date|date:'Y-m-d' }}"
                              data-agenda="{{ i.agenda|escapejs }}"
                              data-mentees="{% for u in i.mentees.all %}{{ u.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                          <i class="bi bi-pencil-square"></i>
                      </button>
                    <a href="{% url 'delete_interaction' i.id %}" class="btn btn-outline-danger btn-sm"
                       onclick="return confirm('Delete this interaction?')">
                      <i class="bi bi-trash"></i>
                    </a>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5" class="text-center text-muted py-4">
                  No interactions recorded yet. Click <strong>Add Interaction</strong> to create one.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
    <!-- Attendance Percentage -->
<div class="card mt-4 shadow-sm border-0">
  <div class="card-header fw-bold">
    <i class="bi bi-person-check"></i> Attendance Percentage
  </div>
  <div class="table-responsive">
    <table class="table mb-0">
      <tr>
        <th>Name</th>
        <th>Moodle</th>
        <th>Attendance %</th>
      </tr>
      {% for a in attendance %}
      <tr>
        <td>{{ a.name }}</td>
        <td>{{ a.moodle }}</td>
        <td>{{ a.percent }}%</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="3" class="text-center text-muted py-3">
          No attendance data available.
        </td>
      </tr>
      {% endfor %}
    </table>
  </div>
</div>

</div>

<!-- Modal: Add Interaction -->
<div class="modal fade" id="interactionModal" tabindex="-1" aria-labelledby="interactionModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form method="post" id="interactionForm">
        {% csrf_token %}
        <input type="hidden" name="interaction_id" id="interaction_id">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="interactionModalLabel">
            <i class="bi bi-chat-square-text me-2"></i>New Interaction
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <!-- Date -->
            <div class="col-md-4">
              <label class="form-label fw-semibold">Date</label>
              <input type="date" name="date" class="form-control" required>
            </div>

            <!-- Semester (Auto) -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Semester (Auto from mentee)</label>
              <input type="text" id="autoSemester" class="form-control" readonly
                     placeholder="Select mentees to auto-fill">
            </div>

            <!-- Duration (optional) -->
            <div class="col-md-4">
              <label class="form-label fw-semibold">Duration (optional)</label>
              <input type="text" name="duration" class="form-control"
                     placeholder="e.g. 1 hour 30 min">
            </div>
          </div>

          <hr class="my-3">

          <!-- Mentees list / attendance -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Mentees Present</label>
            <div class="border rounded p-2" style="max-height: 220px; overflow-y: auto;">
              {% for p in mentees %}
                <div class="form-check">
                  <input class="form-check-input mentee-checkbox"
       type="checkbox"
       value="{{ p.user.id }}"
       name="mentees"
       data-semester="{{ p.semester }}"
       id="mentee_{{ p.user.id }}">

                  <label class="form-check-label" for="mentee_{{ p.user.id }}">
                    {{ p.student_name }} ({{ p.moodle_id }}) – {{ p.branch }}
                  </label>
                </div>
              {% endfor %}
            </div>
            <small class="text-muted d-block mt-1">
              Tick mentees who attended this interaction (this acts as attendance).
            </small>
          </div>

          <hr class="my-3">

          <!-- Agenda -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Agenda Discussed</label>
            <div class="mb-2">
              {% for point in common_agenda %}
                <div class="form-check form-check-inline mb-1">
                  <input class="form-check-input" type="checkbox"
                   name="agenda_points"
                   id="agenda_{{ forloop.counter }}"
                   value="{{ point }}">
                  <label class="form-check-label badge rounded-pill px-3 py-2"
                         for="agenda_{{ forloop.counter }}">
                    {{ point }}
                  </label>
                </div>
              {% endfor %}
            </div>

            <textarea name="agenda_extra" rows="4"
                      class="form-control mt-2"
                      placeholder="Add any extra agenda points or notes here..."></textarea>
              <div id="agendaPreviewBox" class="alert alert-info d-none mt-2">
                  <strong>Previous Agenda:</strong>
                  <span id="agendaPreviewText"></span>
              </div>
          </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                Cancel
            </button>
            <button type="submit" class="btn btn-primary">
                <span class="me-1"><i class="bi bi-send"></i></span> Save Interaction
            </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.modal-body {
  max-height: 65vh;
  overflow-y: auto;
}
.modal-footer {
  position: sticky;
  bottom: 0;
  background: white;
  z-index: 10;
}
/* ✅ Fix invisible agenda text */
.form-check-label.badge {
  background-color: #f1f3f5;
  color: #000;
  border: 1px solid #ced4da;
  cursor: pointer;
}

/* ✅ Highlight selected agenda */
.agenda-active {
  background-color: #0d6efd !important;
  color: #fff !important;
}
</style>


<script>
document.addEventListener("DOMContentLoaded", function () {
  const mentees = document.querySelectorAll(".mentee-checkbox");
  const semesterField = document.getElementById("autoSemester");

  window.restoreSemester = function () {
    const selected = [...mentees].filter(cb => cb.checked);
    const semesters = [...new Set(selected.map(cb => cb.dataset.semester))];
    semesterField.value = semesters.join(", ");
  };

  mentees.forEach(cb => cb.addEventListener("change", restoreSemester));
});


  // Make bootstrap toasts auto-hide
  document.addEventListener("DOMContentLoaded", function () {
  if (window.bootstrap && bootstrap.Toast) {
    const toastElList = [].slice.call(document.querySelectorAll('.toast'));
    toastElList.forEach(function (toastEl) {
      const t = new bootstrap.Toast(toastEl, { delay: 4000 });
      t.show();
    });
  }
});

//Edit form
function openEditModal(id, date, agenda, selectedMentees) {
  const modalEl = document.getElementById("interactionModal");

  // ✅ ALWAYS CREATE A NEW MODAL INSTANCE (SAFE FOR ALL BOOTSTRAP 5)
  const modal = new bootstrap.Modal(modalEl);

  // ✅ Set hidden ID
  document.getElementById("interaction_id").value = id;

  // ✅ Set date
  document.querySelector("input[name='date']").value = date;

  // ✅ Reset all mentee checkboxes
  document.querySelectorAll(".mentee-checkbox").forEach(cb => {
    cb.checked = false;
  });

  // ✅ Re-check saved mentees
  selectedMentees.forEach(mid => {
    const checkbox = document.getElementById("mentee_" + mid);
    if (checkbox) checkbox.checked = true;
  });

  // ✅ Restore semester after mentees restored
  if (window.restoreSemester) restoreSemester();

  // ✅ Reset agenda checkboxes + highlight
  document.querySelectorAll("input[name='agenda_points']").forEach(cb => {
    cb.checked = false;
    const label = document.querySelector(`label[for="${cb.id}"]`);
    if (label) label.classList.remove("agenda-active");
  });

  // ✅ Split agenda text
  const agendaParts = agenda.split(";").map(p => p.trim()).filter(Boolean);

  // ✅ Restore agenda checkboxes
  document.querySelectorAll("input[name='agenda_points']").forEach(cb => {
    if (agendaParts.includes(cb.value)) {
      cb.checked = true;
      const label = document.querySelector(`label[for="${cb.id}"]`);
      if (label) label.classList.add("agenda-active");
    }
  });

  // ✅ Restore extra agenda but remove predefined ones
  const predefined = [...document.querySelectorAll("input[name='agenda_points']")]
                      .map(cb => cb.value);

  const extraText = agendaParts.filter(p => !predefined.includes(p)).join("; ");
  document.querySelector("textarea[name='agenda_extra']").value = extraText;

  // ✅ Preview
  const previewBox = document.getElementById("agendaPreviewBox");
  const previewText = document.getElementById("agendaPreviewText");
  if (previewBox && previewText) {
    previewText.innerText = agenda;
    previewBox.classList.remove("d-none");
  }

  // ✅ SHOW MODAL (NO VERSION ISSUES)
  modal.show();
}

    document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.addEventListener("click", function () {
      const id = this.dataset.id;
      const date = this.dataset.date;
      const agenda = this.dataset.agenda;
      const mentees = this.dataset.mentees
        ? this.dataset.mentees.split(",").map(Number)
        : [];

      openEditModal(id, date, agenda, mentees);
    });
  });
});
</script>
{% endblock %}
